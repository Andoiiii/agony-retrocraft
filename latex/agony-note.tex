\RequirePackage{chngcntr}
\newcommand{\setsectiontitle}[1]{
  \titleformat{\section}{\normalfont\large\bfseries}{#1~\thesection}{1em}{}
  \settowidth{\cftsecnumwidth}{#1~0000~}
  \renewcommand\cftsecpresnum{#1~}
  \addtocontents{toc}{\protect\renewcommand*{\protect\cftsecpresnum}{#1~}}
}
\bookmarksetup{numbered}

\setlength\topsep{6pt}

\declaretheorem[style=definition,name=Definition,refname={definition,definitions},
  thmbox={M,leftmargin=1.5em,rightmargin=1.5em,nocut,headstyle=\textbf{Definition},bodystyle=\noindent}]{definition}
\NewDocumentEnvironment{defn}{oO{#1}}{\IfNoValueTF{#1}{\definition}{\definition[#1]\index{#2}}}{\enddefinition}
\NewDocumentEnvironment{defn*}{o}{\IfNoValueTF{#1}{\definition}{\definition[#1]}}{\enddefinition}
\declaretheorem[name=Theorem,refname={theorem,theorems},
  thmbox={L,leftmargin=1.5em,rightmargin=1.5em,nocut,bodystyle=\noindent}]{theorem}
\declaretheorem[name=Conjecture,refname={conjecture,conjectures},
  thmbox={L,leftmargin=1.5em,rightmargin=1.5em,nocut,bodystyle=\noindent}]{conjecture}
\declaretheorem[name=Lemma,refname={lemma,lemmas},numberwithin=section,
  thmbox={M,leftmargin=1.5em,rightmargin=1.5em,nocut,bodystyle=\noindent}]{lemma}
\declaretheorem[name=Proposition,refname={proposition,propositions},numberwithin=section,
  thmbox={S,leftmargin=1.5em,rightmargin=1.5em,nocut,bodystyle=\noindent}]{prop}
\declaretheorem[style=remark,unnumbered]{remark}
\declaretheorem[refname={claim,claims},style=remark,numberwithin=section]{claim}
\declaretheorem[style=remark,unnumbered]{corollary}

\declaretheorem[refname={problem,problems},style=definition,numberwithin=chapter,
  thmbox={L,leftmargin=1.5em,rightmargin=1.5em,nocut,bodystyle=\noindent}]{problem}
\declaretheorem[refname={example,examples},style=definition,name=Example,numberwithin=section]{example}
\declaretheorem[name=Exercise,refname={exercise,exercises},numberwithin=section,style=definition]{xca}

\RequirePackage[hybrid,underscores=false]{markdown}

% Use inside of definitions: "a \term{thing} is a whatever"
\makeindex[columns=3, title=Index of Defined Terms, intoc]
\indexsetup{level=\chapter*,toclevel=section}

% For thmbox (see tex.se/41100)
\RequirePackage{tablefootnote}
\newcommand{\spewnotes}{\tfn@tablefootnoteprintout\global\let\tfn@tablefootnoteprintout\relax\gdef\tfn@fnt{0}}

% List of lectures (marked in margin)
\RequirePackage{multicol,xpatch}
\RequirePackage{marginnote}
\newlistof{lecture}{lec.toc}{Lectures}
\xpatchcmd{\listoflecture}{\chapter*}{\section*}{}{}
\settowidth{\cftlecturenumwidth}{Lecture~0000~}
\newcommand{\lecture}[1]{%
  \refstepcounter{lecture}%
  \addcontentsline{lec.toc}{lecture}{\protect\numberline{Lecture~\thelecture}#1}%
  \marginnote{\normalsize{\textit{Lecture \thelecture\\#1}}}}
